<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Final model exploration | Spaceship Titanic - A comprehensive guide</title>
<meta name="author" content="Vanja Manborg">
<meta name="description" content="Let’s summarise what we have so far: A variable set with second level interactions that we think offer the best accuracy that I can handle with my computational power A set of tuning parameters...">
<meta name="generator" content="bookdown 0.37 with bs4_book()">
<meta property="og:title" content="Chapter 8 Final model exploration | Spaceship Titanic - A comprehensive guide">
<meta property="og:type" content="book">
<meta property="og:url" content="https://spaceshiptitanic.manborgconsulting.com/final-model-exploration.html">
<meta property="og:description" content="Let’s summarise what we have so far: A variable set with second level interactions that we think offer the best accuracy that I can handle with my computational power A set of tuning parameters...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Final model exploration | Spaceship Titanic - A comprehensive guide">
<meta name="twitter:description" content="Let’s summarise what we have so far: A variable set with second level interactions that we think offer the best accuracy that I can handle with my computational power A set of tuning parameters...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="libs/jquery-migrate-3.1.0/jquery-migrate-3.1.0.min.js"></script><link href="libs/slick-1.8.1/slick/slick.css" rel="stylesheet">
<link href="libs/slick-1.8.1/slick/slick-theme.css" rel="stylesheet">
<script src="libs/slick-1.8.1/slick/slick.min.js"></script><script src="libs/css-resize-1.2.1/ResizeSensor.js"></script><script src="libs/css-resize-1.2.1/ElementQueries.js"></script><link href="libs/slickR-0.0.2/slick.css" rel="stylesheet">
<link href="libs/slickR-0.0.2/slick-theme.css" rel="stylesheet">
<script src="libs/slickR-0.0.2/slickR.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Spaceship Titanic - A comprehensive guide</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="early-data-exploration.html"><span class="header-section-number">2</span> Early data exploration</a></li>
<li><a class="" href="handle-missing-data.html"><span class="header-section-number">3</span> Handle missing data</a></li>
<li><a class="" href="exploration-of-categorical-variables.html"><span class="header-section-number">4</span> Exploration of categorical variables</a></li>
<li><a class="" href="exploration-of-numerical-variables.html"><span class="header-section-number">5</span> Exploration of numerical variables</a></li>
<li><a class="" href="interactions.html"><span class="header-section-number">6</span> Interactions</a></li>
<li><a class="" href="feature-selection-and-elimination.html"><span class="header-section-number">7</span> Feature selection and elimination</a></li>
<li><a class="active" href="final-model-exploration.html"><span class="header-section-number">8</span> Final model exploration</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/MoonCastle85/SpaceshipTitanicBook">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="final-model-exploration" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Final model exploration<a class="anchor" aria-label="anchor" href="#final-model-exploration"><i class="fas fa-link"></i></a>
</h1>
<p>Let’s summarise what we have so far:</p>
<ol style="list-style-type: decimal">
<li><p>A variable set with second level interactions that we think offer the best accuracy that I can handle with my computational power</p></li>
<li><p>A set of tuning parameters for several models that we think are likely to be optimal</p></li>
</ol>
<p>Now we must decide which model to use. There are many options but I will limit myself to three: GLM, RandomForest and Lasso/Ridge.
Before we get to the models, let’s first summarise all the preprocessing of the training data that we’ve done.</p>
<div id="summarise-preprocess" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Summarise preprocess<a class="anchor" aria-label="anchor" href="#summarise-preprocess"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create group variables, seperate CabinNumber, Deck and Side from Cabin</span></span>
<span><span class="va">train2</span> <span class="op">&lt;-</span> <span class="fu">useful_features</span><span class="op">(</span><span class="va">train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Replace structurally missing NA</span></span>
<span><span class="va">train3</span> <span class="op">&lt;-</span> <span class="fu">my_na_replace</span><span class="op">(</span><span class="va">train2</span><span class="op">)</span></span>
<span><span class="va">train3</span> <span class="op">&lt;-</span> <span class="fu">useful_features</span><span class="op">(</span><span class="va">train3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># KNN impute remaining missing values</span></span>
<span><span class="va">train3_for_knn</span> <span class="op">&lt;-</span> <span class="va">train3</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu">where</span><span class="op">(</span><span class="va">is.factor</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vars_to_impute</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HomePlanet"</span>, <span class="st">"CryoSleep"</span>, <span class="st">"Destination"</span>, <span class="st">"Age"</span>, <span class="st">"VIP"</span>, <span class="st">"RoomService"</span>, <span class="st">"FoodCourt"</span>, <span class="st">"ShoppingMall"</span>,</span>
<span>                    <span class="st">"Spa"</span>, <span class="st">"VRDeck"</span>, <span class="st">"Deck"</span>, <span class="st">"Side"</span>, <span class="st">"CabinNumber"</span>, <span class="st">"LastName"</span><span class="op">)</span></span>
<span><span class="va">vars_for_imputing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HomePlanet"</span>, <span class="st">"CryoSleep"</span>, <span class="st">"Destination"</span>, <span class="st">"Age"</span>, <span class="st">"VIP"</span>, <span class="st">"RoomService"</span>, <span class="st">"FoodCourt"</span>,</span>
<span>                              <span class="st">"ShoppingMall"</span>, <span class="st">"Spa"</span>, <span class="st">"VRDeck"</span>, <span class="st">"PassengerGroup"</span>, <span class="st">"Deck"</span>, <span class="st">"Side"</span>, <span class="st">"CabinNumber"</span>,</span>
<span>                              <span class="st">"PassengerGroupSize"</span>, <span class="st">"DestinationsPerGroup"</span>, <span class="st">"CabinsPerGroup"</span>,</span>
<span>                              <span class="st">"CryoSleepsPerGroup"</span>, <span class="st">"VIPsPerGroup"</span>, <span class="st">"LastNamesPerGroup"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train3_noNA</span> <span class="op">&lt;-</span> <span class="va">train3_for_knn</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">train3_for_knn</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  </span>
<span><span class="va">knn_impute_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">Transported</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train3_noNA</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_normalize</span><span class="op">(</span><span class="va">Age</span>, <span class="va">CabinNumber</span>, <span class="va">RoomService</span>, <span class="va">FoodCourt</span>, <span class="va">ShoppingMall</span>, <span class="va">Spa</span>, <span class="va">VRDeck</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_impute_knn</span><span class="op">(</span>recipe <span class="op">=</span> <span class="va">.</span>, <span class="fu">all_of</span><span class="op">(</span><span class="va">vars_to_impute</span><span class="op">)</span>, impute_with <span class="op">=</span> <span class="fu">imp_vars</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">vars_for_imputing</span><span class="op">)</span><span class="op">)</span>, neighbors <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8584</span><span class="op">)</span></span>
<span><span class="va">knn_impute_prep</span> <span class="op">&lt;-</span> <span class="va">knn_impute_rec</span> <span class="op">%&gt;%</span> <span class="fu">prep</span><span class="op">(</span>strings_as_factors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8584</span><span class="op">)</span></span>
<span><span class="va">knn_impute_bake</span> <span class="op">&lt;-</span> <span class="fu">bake</span><span class="op">(</span><span class="va">knn_impute_prep</span>, new_data <span class="op">=</span> <span class="va">train3_for_knn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">knn_impute_res</span> <span class="op">&lt;-</span> <span class="va">knn_impute_bake</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Age</span>, <span class="va">CabinNumber</span>, <span class="va">RoomService</span>, <span class="va">FoodCourt</span>, <span class="va">ShoppingMall</span>, <span class="va">Spa</span>, <span class="va">VRDeck</span><span class="op">)</span>,</span>
<span>                .fns <span class="op">=</span> <span class="op">~</span> <span class="fu">rev_normalization</span><span class="op">(</span><span class="va">.x</span>, <span class="va">knn_impute_prep</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fixed KNN imputation where structural missing rules were broken</span></span>
<span><span class="va">fixed_knn</span> <span class="op">&lt;-</span> <span class="fu">fix_knn</span><span class="op">(</span><span class="va">knn_impute_res</span><span class="op">)</span></span>
<span><span class="va">train4</span> <span class="op">&lt;-</span> <span class="fu">useful_features2</span><span class="op">(</span><span class="va">fixed_knn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add new features we've discovered from our visual exploration</span></span>
<span><span class="va">train5</span> <span class="op">&lt;-</span> <span class="fu">add_grp_features</span><span class="op">(</span><span class="va">train4</span><span class="op">)</span></span>
<span><span class="va">train6</span> <span class="op">&lt;-</span> <span class="fu">add_name_features</span><span class="op">(</span><span class="va">train5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get our variables in order for modelling</span></span>
<span><span class="va">train7</span> <span class="op">&lt;-</span> <span class="va">train6</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Cabin</span>, <span class="va">Name</span>, <span class="va">LastName</span>, <span class="va">PassengerCount</span>, <span class="va">HomePlanetsPerGroup</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">PassengerGroupSize</span>, <span class="va">Solo</span>, <span class="va">LargeGroup</span>, <span class="va">TravelTogether</span>, <span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"PerGroup"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                .fns <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">train7</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Roles <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">Variables</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PassengerId"</span><span class="op">)</span>, <span class="st">"id"</span>, <span class="st">"predictor"</span><span class="op">)</span>,</span>
<span>         Roles <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">Variables</span> <span class="op">==</span> <span class="st">"Transported"</span>, <span class="st">"outcome"</span>, <span class="va">Roles</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># final_interactions &lt;- rfe_vars_best2 %&gt;%</span></span>
<span><span class="co">#   select(ForFormula, RevFormula) %&gt;%</span></span>
<span><span class="co">#   unlist() %&gt;%</span></span>
<span><span class="co">#   unname() %&gt;%</span></span>
<span><span class="co">#   unique(.) %&gt;%</span></span>
<span><span class="co">#   str_flatten(., collapse = "+") %&gt;%</span></span>
<span><span class="co">#   str_c("~", .) %&gt;%</span></span>
<span><span class="co">#   as.formula(.)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># save(final_interactions, file = "Final interactions.RData")</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"Final interactions.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8584</span><span class="op">)</span></span>
<span><span class="va">final_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">train7</span>, prop <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">final_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">final_split</span><span class="op">)</span></span>
<span><span class="va">final_test</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">final_split</span><span class="op">)</span></span>
<span><span class="va">final_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">final_train</span>, v <span class="op">=</span> <span class="fl">10</span>, repeats <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_rec_int</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span>x <span class="op">=</span> <span class="va">final_train</span>, vars <span class="op">=</span> <span class="va">my_vars</span><span class="op">$</span><span class="va">Variables</span>, roles <span class="op">=</span> <span class="va">my_vars</span><span class="op">$</span><span class="va">Roles</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_normalize</span><span class="op">(</span><span class="va">Age</span>, <span class="va">RoomService</span>, <span class="va">FoodCourt</span>, <span class="va">ShoppingMall</span>, <span class="va">Spa</span>, <span class="va">VRDeck</span>, <span class="va">TotalSpent</span>, <span class="va">CabinNumber</span>, <span class="va">LastNameAsNumber</span>, <span class="va">PassengerGroup</span>,</span>
<span>                 <span class="va">TotalSpentPerGroup</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="fu">all_nominal_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_interact</span><span class="op">(</span><span class="va">final_interactions</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_zv</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_corr</span><span class="op">(</span><span class="fu">all_numeric_predictors</span><span class="op">(</span><span class="op">)</span>, threshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span>x <span class="op">=</span> <span class="va">final_train</span>, vars <span class="op">=</span> <span class="va">my_vars</span><span class="op">$</span><span class="va">Variables</span>, roles <span class="op">=</span> <span class="va">my_vars</span><span class="op">$</span><span class="va">Roles</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_normalize</span><span class="op">(</span><span class="va">Age</span>, <span class="va">RoomService</span>, <span class="va">FoodCourt</span>, <span class="va">ShoppingMall</span>, <span class="va">Spa</span>, <span class="va">VRDeck</span>, <span class="va">TotalSpent</span>, <span class="va">CabinNumber</span>, <span class="va">LastNameAsNumber</span>, <span class="va">PassengerGroup</span>,</span>
<span>                 <span class="va">TotalSpentPerGroup</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="fu">all_nominal_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_zv</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_corr</span><span class="op">(</span><span class="fu">all_numeric_predictors</span><span class="op">(</span><span class="op">)</span>, threshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="glm" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> GLM<a class="anchor" aria-label="anchor" href="#glm"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm_final_bake</span> <span class="op">&lt;-</span> <span class="va">final_rec</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">prep</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">bake</span><span class="op">(</span>new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_acc</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">accuracy</span><span class="op">)</span></span>
<span><span class="va">pen_ctrl</span> <span class="op">&lt;-</span> <span class="fu">control_grid</span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">TRUE</span>, save_pred <span class="op">=</span> <span class="cn">TRUE</span>, save_workflow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pen_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>mixture <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span>, penalty <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="op">-</span><span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_final_mod</span> <span class="op">&lt;-</span> <span class="fu">logistic_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glm"</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_final_wf</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">final_rec</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">glm_final_mod</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8584</span><span class="op">)</span></span>
<span><span class="va">glm_final_fit</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">glm_final_wf</span>, <span class="va">final_train</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: glm.fit: fitted probabilities numerically 0 or 1</span></span>
<span><span class="co">#&gt; occurred</span></span>
<span></span>
<span><span class="va">glm_final_pred</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span><span class="op">(</span>Actual <span class="op">=</span> <span class="va">final_test</span><span class="op">$</span><span class="va">Transported</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">glm_final_fit</span>, <span class="va">final_test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">glm_final_acc_int</span> <span class="op">&lt;-</span> <span class="fu">accuracy</span><span class="op">(</span>data <span class="op">=</span> <span class="va">glm_final_pred</span>, truth <span class="op">=</span> <span class="va">Actual</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="va">glm_final_acc_int</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.791</span></span></code></pre></div>
<p>The results from the GLM model aren’t great but are close to the ones we expected from our resampling and feature evaluation process.</p>
</div>
<div id="glmnet-lassoridge" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> GLMNET Lasso/Ridge<a class="anchor" aria-label="anchor" href="#glmnet-lassoridge"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_glm_params</span> <span class="op">&lt;-</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">pen_int_tune</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glmnet_final_mod</span> <span class="op">&lt;-</span> <span class="fu">logistic_reg</span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu">pluck</span><span class="op">(</span><span class="va">best_glm_params</span><span class="op">$</span><span class="va">penalty</span><span class="op">)</span>, mixture <span class="op">=</span> <span class="fu">pluck</span><span class="op">(</span><span class="va">best_glm_params</span><span class="op">$</span><span class="va">mixture</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glmnet"</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glmnet_final_wf</span> <span class="op">&lt;-</span> <span class="va">glm_final_wf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">update_model</span><span class="op">(</span><span class="va">glmnet_final_mod</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8584</span><span class="op">)</span></span>
<span><span class="va">glmnet_final_fit</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">glmnet_final_wf</span>, <span class="va">final_train</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glmnet_final_pred</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span><span class="op">(</span>Actual <span class="op">=</span> <span class="va">final_test</span><span class="op">$</span><span class="va">Transported</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">glmnet_final_fit</span>, <span class="va">final_test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">glmnet_final_acc</span> <span class="op">&lt;-</span> <span class="fu">accuracy</span><span class="op">(</span>data <span class="op">=</span> <span class="va">glmnet_final_pred</span>, truth <span class="op">=</span> <span class="va">Actual</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="va">glmnet_final_acc</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.787</span></span></code></pre></div>
</div>
<div id="randomforest" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> RandomForest<a class="anchor" aria-label="anchor" href="#randomforest"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_acc</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">accuracy</span><span class="op">)</span></span>
<span><span class="va">rf_ctrl</span> <span class="op">&lt;-</span> <span class="fu">control_grid</span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">TRUE</span>, save_pred <span class="op">=</span> <span class="cn">TRUE</span>, save_workflow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">rf_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>trees <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">2000</span>, <span class="fl">10000</span><span class="op">)</span>, min_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_final_mod_tune</span> <span class="op">&lt;-</span> <span class="fu">rand_forest</span><span class="op">(</span>trees <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>, min_n <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"randomForest"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># my_cluster &lt;- makeCluster(detectCores() - 1, type = 'SOCK')</span></span>
<span><span class="co"># registerDoSNOW(my_cluster)</span></span>
<span><span class="co"># clusterExport(cl = my_cluster, "final_interactions")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># system.time({</span></span>
<span><span class="co">#   set.seed(8584)</span></span>
<span><span class="co">#   rf_final_tune &lt;- rf_final_mod_tune %&gt;%</span></span>
<span><span class="co">#     tune_grid(final_rec, resamples = final_folds, metrics = my_acc, control = rf_ctrl, grid = rf_grid)</span></span>
<span><span class="co"># })</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># save(rf_final_tune, file = "Final randomForest tune.RData")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># stopCluster(my_cluster)</span></span>
<span><span class="co"># unregister()</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"Final randomForest tune.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">show_best</span><span class="op">(</span><span class="va">rf_final_tune</span>, metric <span class="op">=</span> <span class="st">"accuracy"</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">trees</span>, y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Tune results for RandomForest"</span>, x <span class="op">=</span> <span class="st">"Number of trees"</span>, y <span class="op">=</span> <span class="st">"Resample accuracy"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="SpaceshipTitanicBook_files/figure-html/randomForest-tune-1.png" width="672">
The results from the model tuning indicate that the improvement is very limited with more trees than somewhere around 2000 so I will assume this as the optimal. With tree based models, too much trees can overfit the data so it’s a good idea not to</div>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_final_mod</span> <span class="op">&lt;-</span> <span class="fu">rand_forest</span><span class="op">(</span>trees <span class="op">=</span> <span class="fl">2000</span>, min_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"randomForest"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_final_wf</span> <span class="op">&lt;-</span> <span class="va">glm_final_wf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">update_model</span><span class="op">(</span><span class="va">rf_final_mod</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8584</span><span class="op">)</span></span>
<span><span class="va">rf_final_fit</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">rf_final_wf</span>, <span class="va">final_train</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_final_pred</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span><span class="op">(</span>Actual <span class="op">=</span> <span class="va">final_test</span><span class="op">$</span><span class="va">Transported</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_final_fit</span>, <span class="va">final_test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_final_acc</span> <span class="op">&lt;-</span> <span class="fu">accuracy</span><span class="op">(</span>data <span class="op">=</span> <span class="va">rf_final_pred</span>, truth <span class="op">=</span> <span class="va">Actual</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="va">rf_final_acc</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.799</span></span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="feature-selection-and-elimination.html"><span class="header-section-number">7</span> Feature selection and elimination</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#final-model-exploration"><span class="header-section-number">8</span> Final model exploration</a></li>
<li><a class="nav-link" href="#summarise-preprocess"><span class="header-section-number">8.1</span> Summarise preprocess</a></li>
<li><a class="nav-link" href="#glm"><span class="header-section-number">8.2</span> GLM</a></li>
<li><a class="nav-link" href="#glmnet-lassoridge"><span class="header-section-number">8.3</span> GLMNET Lasso/Ridge</a></li>
<li><a class="nav-link" href="#randomforest"><span class="header-section-number">8.4</span> RandomForest</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/MoonCastle85/SpaceshipTitanicBook/blob/master/07-models.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/MoonCastle85/SpaceshipTitanicBook/edit/master/07-models.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Spaceship Titanic - A comprehensive guide</strong>" was written by Vanja Manborg. It was last built on 2024-01-25.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
